{% extends "base.html" %}
{% block content %}
  <h1>📊 Dashboard Monitoring VPS</h1>

  <!-- Voyant santé -->
  <div id="healthStatus">⏳ Vérification...</div>

  <!-- Graphiques -->
  <canvas id="sysChart"></canvas>

  <!-- Processus -->
  <h2>Top 5 Processus</h2>
  <ul id="processList"></ul>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <script>
    async function fetchData() {
      const res = await fetch("/monitor/status");
      return res.json();
    }

    async function fetchHealth() {
      const res = await fetch("/monitor/health");
      return res.json();
    }

    async function fetchProcesses() {
      const res = await fetch("/monitor/processes");
      return res.json();
    }

    async function updateDashboard(chart) {
      // === Mettre à jour stats système ===
      const data = await fetchData();
      chart.data.datasets[0].data = [data.cpu_usage, data.ram_usage, data.disk_usage];
      chart.update();

      // === Mettre à jour santé système ===
      const health = await fetchHealth();
      const healthDiv = document.getElementById("healthStatus");
      if (health.status === "OK") {
        healthDiv.textContent = "✅ Système OK";
        healthDiv.style.background = "#2ecc71";  // vert
        healthDiv.style.color = "white";
      } else {
        healthDiv.textContent = "🔴 Alerte !";
        healthDiv.style.background = "#e74c3c";  // rouge
        healthDiv.style.color = "white";
      }

      // === Mettre à jour liste des processus ===
      const processes = await fetchProcesses();
      let list = document.getElementById("processList");
      list.innerHTML = "";
      processes.forEach(p => {
        let li = document.createElement("li");
        li.textContent = `${p.name} (CPU: ${p.cpu_percent}%, RAM: ${p.memory_percent.toFixed(1)}%)`;
        list.appendChild(li);
      });
    }

    // Chart.js setup
    const ctx = document.getElementById("sysChart");
    const sysChart = new Chart(ctx, {
      type: "bar",
      data: {
        labels: ["CPU %", "RAM %", "Disk %"],
        datasets: [{
          label: "Utilisation",
          data: [0, 0, 0],
          backgroundColor: ["#3498db", "#2ecc71", "#e74c3c"]
        }]
      },
      options: { responsive: true, scales: { y: { beginAtZero: true, max: 100 } } }
    });

    // Refresh toutes les 5s
    setInterval(() => updateDashboard(sysChart), 5000);
    updateDashboard(sysChart);
  </script>
{% endblock %}
